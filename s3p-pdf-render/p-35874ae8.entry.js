import{r as t,c as e,g as i,h as s,a as n}from"./p-d5a6e412.js";import{b as h}from"./p-6f5893c5.js";import{r as a,b as r,c as o,d as c,p as l}from"./p-98feef0c.js";import{i as d}from"./p-924cb6ab.js";import"./p-3e8ff66b.js";function p(t){let e=t.findIndex((t=>new Date(t.ts).valueOf()===new Date(this.eventSelect.event.ts).valueOf()&&t.activity));t[e].activity=this.activityEdit;this.eventsModified=[{type:"edit",event:t[e]}];let i=e-1,s;while(t[i]&&(!t[i].activity||t[i].activity===this.activityEdit)){if(t[i].activity===this.activityEdit){s=t[i]}i=i-1}let n=e+1;while(t[n]&&(!t[n].activity||t[n].activity===this.activityEdit)){n=n+1}const h=t[n]?t[n].ts:this.lastEvent;if(i&&t[i]&&s){s.modified=true;this.eventSelectEdited={start:new Date(s.ts),end:new Date(h)}}else{t[e].modified=true;this.eventSelectEdited={start:new Date(t[e].ts),end:new Date(h)}}return t}function m(t){this.activityEdit=t.value;this.eventsEdited=this.setEventEdited();this.timelineEditedElement.updatePeriodAndEvent(this.eventsEdited,[],this.lastEvent)}function u(t){this.eventsModified=[];t=t.filter((t=>new Date(t.ts)<new Date(this.startEdit)||new Date(t.ts)>=new Date(this.eventSelect.end)||new Date(t.ts).valueOf()===new Date(this.eventSelect.event.ts).valueOf()));for(let e=0;e<t.length;e++){const i=t[e];if(new Date(i.ts).valueOf()===new Date(this.eventSelect.event.ts).valueOf()&&i.activity){i.ts=new Date(this.startEdit).toISOString();i.modified=true;this.eventsModified.push({type:"edit",event:i})}}if(new Date(this.eventSelect.event.ts)<this.startEdit){const e=Object.assign({},this.eventSelect.event,{activity:"R",modified:true});t.push(e);this.eventsModified.push({type:"create",event:e});t=t.sort(((t,e)=>+new Date(t.ts)-+new Date(e.ts)))}return t}function f(t){if(t.detail){this.startEdit=t.detail;this.eventsEdited=this.setEventEdited();this.timelineEditedElement.updatePeriodAndEvent(this.eventsEdited,[],this.lastEvent);this.setHaveError(false)}else{this.setHaveError(true)}}function w(t){let e=t.find((t=>new Date(t.ts).valueOf()===new Date(this.eventSelect.event.ts).valueOf()));if(e){e.modified=true}const i=Object.assign({},this.eventSelect.event,{activity:"R",ts:new Date(this.endEdit).toISOString(),modified:true});t.push(i);this.eventsModified=[{type:"create",event:i}];t=t.sort(((t,e)=>+new Date(t.ts)-+new Date(e.ts)));return t}function v(t){if(t.detail){this.endEdit=t.detail;this.eventsEdited=this.setEventEdited();this.timelineEditedElement.updatePeriodAndEvent(this.eventsEdited,[],this.lastEvent);this.setHaveError(false)}else{this.setHaveError(true)}}function D(t){if(this.actionType==="edit"){t=t.filter((t=>new Date(this.eventSelect.start).valueOf()===new Date(t.ts).valueOf()&&new Date(this.eventSelect.end).valueOf()===new Date(t.end).valueOf()&&t.correction?false:true))}for(const e of this.customActivityAdd.events){t.push(Object.assign({modified:true},e.event))}this.eventsModified=this.customActivityAdd.events;t=t.sort(((t,e)=>+new Date(t.ts)-+new Date(e.ts)));return t}function C(){if(this.eventSelect.event.customActivityId){this.activityAddEdit={customActivityId:this.eventSelect.event.customActivityId,start:new Date(this.eventSelect.event.ts),end:new Date(this.eventSelect.event.end)}}}function b(t){this.customActivityAdd=t.detail;if(this.timelineEditedElement){this.eventsEdited=this.setEventEdited();this.timelineEditedElement.updatePeriodAndEvent(this.eventsEdited,[],this.lastEvent)}}function g(){if(this.eventSelect&&this.eventSelect.event&&this.eventSelect.event.activity==="R"){return{start:this.eventSelect.start,end:this.eventSelect.end}}else{return null}}const y=".s3pChartComponent.editorTimeline{height:100%}.s3pChartComponent .containerCorrection{height:calc(100% - 47px);overflow:scroll;overflow-x:hidden}.s3pChartComponent .btnCorrectionValid{position:sticky;bottom:0;width:100%;background-color:white}.s3pChartComponent.editorTimeline .btnChart{padding:0.5em 0.5em 0.5em 0;width:99%}.s3pChartComponent .container-form{margin:15px;position:relative;overflow:auto;margin-top:10px}.s3pChartComponent .container-remplaceMode,.s3pChartComponent .container-textarea,.s3pChartComponent .container-dateChange{display:flex;align-items:center;justify-content:center;margin:10px}.s3pChartComponent .container-dateChange{align-items:baseline !important}.s3pChartComponent .container-textarea{align-items:end !important}.s3pChartComponent .contains-timeline{display:grid;grid-template-columns:60px 1fr;align-items:center;margin-top:5px;position:relative}.s3pChartComponent .btn-refresh{align-self:center}";const k=class{constructor(s){t(this,s);this.sendTimelineCorrection=e(this,"sendTimelineCorrection",7);this.replaceActivity=p;this.setActivityEdit=m;this.editStartActivity=u;this.setStartEdit=f;this.editEndActivity=w;this.setEndEdit=v;this.addActivity=D;this.initActivityAdd=C;this.setLimitToAddCustomActivity=g;this.setCustomActivityAdd=b;this.removeHours=a;this.addMinute=r;this.removeMinute=o;this.addHours=c;this.validateCorrectionsMessage="validateCreation";this.showWarningMessage=false;this.activitiesOutsideVehicle=[];this.tab=1;this.customActivityAdd={events:[],start:null,end:null};this.blockEdition=false;this.haveError={1:false,2:false,3:false,4:false};this.resourcesUrl=i(this,"resourcesUrl")}async componentWillLoad(){this.log=h("s3pChart:timeline");this.i18n=new d(this.el);await this.i18n.load(this.resourcesUrl);this.maxStartFutur=new Date;this.startActivity={start:this.eventSelect.start,max:this.eventSelect.end,min:o(new Date(this.eventSelect.start),1)};this.endActivity={end:this.eventSelect.end,min:this.eventSelect.start,max:r(new Date(this.eventSelect.end),1)}}async componentDidLoad(){this.initActivityAdd();this.eventsEdited=this.events.map((t=>Object.assign({},t)));this.eventSelectEdited=Object.assign({},this.eventSelect);this.display_start=o(new Date(this.eventSelect.start),15);this.display_end=r(new Date(this.eventSelect.end),15);if(this.eventSelect.invalidCorrection){this.blockEdition=true}if(this.actionType==="edit"&&this.eventSelect.event.correction){this.comment=this.eventSelect.event.correction.comment;if(this.eventSelect.event.correction.new){if(this.eventSelect.event.customActivityId){this.tab=4}else{setTimeout((()=>{this.setActivityEdit({value:this.eventSelect.event.correction.new.activity})}),1e3)}}if(this.eventSelect.event.correction.toValidate){this.showWarningMessage=true}else{this.validateCorrectionsMessage="validateEdition"}}}onChangeStartAndEndHandler(t,e){if(t.detail.start&&t.detail.end&&!t.detail.firstLoad){if(e===0){this.timelineEditedElement.updateStartAndEnd(t.detail.start,t.detail.end)}else{this.timelineElement.updateStartAndEnd(t.detail.start,t.detail.end)}}}changeTab(t){this.tab=t;this.eventsEdited=this.setEventEdited();this.timelineEditedElement.updatePeriodAndEvent(this.eventsEdited,[],this.lastEvent);if(t===4&&this.actionType!=="edit"){this.validateCorrectionsMessage="validate"}}getPossibleActivities(t){let e=["W","A","R"];return e.filter((e=>t!==e))}setStartAndEndDisplay(t,e,i){this.timelineEditedElement.updateStartAndEnd(o(new Date(t),new Date(i)),r(new Date(e),new Date(i)));setTimeout((()=>{this.timelineElement.updateStartAndEnd(o(new Date(t),new Date(i)),r(new Date(e),new Date(i)))}),500)}setComment(t){this.comment=t.target.value}sendCorrection(){let t=[];switch(this.tab){case 1:case 2:case 3:if(this.actionType==="edit"&&!this.eventsModified){if(this.eventSelect.event.correction.toValidate){const e=this.eventSelect.event.correction;if(e.origin.correction){delete e.origin.correction}t.push(Object.assign(Object.assign({toValidate:false,source:"legalfiles",correctionId:e._id},e.type==="edit"&&{origin:e.origin}),{new:e.new,comment:this.comment,type:e.type,actionType:this.actionType}))}}else{for(let e of this.eventsModified){const i=Object.assign({end:this.eventSelect.end},e.event);delete i.tooltip;delete i.modified;let s=Object.assign({end:this.eventSelect.end},this.eventSelect.event);delete s.tooltip;if(s.correction){delete s.correction}let n;if(i.provider&&i.provider==="legalfilesdecoder"){n="legalfiles"}else{n="chronology"}t.push(Object.assign({type:e.type,origin:e.type==="edit"?s:null,new:i,source:n,comment:this.comment,actionType:this.actionType},this.actionType&&this.actionType==="edit"&&{correctionId:this.eventSelect.event.correction._id}))}}this.sendTimelineCorrection.emit(t);break;case 4:if(this.actionType==="edit"&&!this.eventsModified){const e=this.eventSelect.event.correction;t.push({correctionId:e._id,origin:null,new:e.new,comment:this.comment,type:e.type,actionType:this.actionType})}else{for(let e of this.eventsModified){const i=Object.assign({},e.event);const s=this.eventSelect.event.correction;if(this.actionType==="edit"&&this.eventsModified.length===1){t.push({correctionId:s._id,origin:null,new:i,comment:this.comment,type:s.type,actionType:this.actionType})}else{t.push(Object.assign({type:e.type,origin:null,new:i,source:"legalfiles",comment:this.comment},this.actionType==="edit"&&s&&{correctionIdToDelete:s._id}))}}}this.sendTimelineCorrection.emit(t);break}}isDisabledForm(){let t=["W","A","R"];switch(this.tab){case 1:return!this.blockEdition&&this.comment&&this.activityEdit&&t.includes(this.activityEdit)?false:true;case 2:return!this.blockEdition&&this.comment&&this.startEdit&&new Date(this.startEdit)>new Date(this.eventSelect.start)&&new Date(this.startEdit)<new Date(this.eventSelect.end)?false:true;case 3:return!this.blockEdition&&this.comment&&this.endEdit&&new Date(this.endEdit)>new Date(this.eventSelect.start)&&new Date(this.endEdit)<new Date(this.eventSelect.end)?false:true;case 4:return!this.customActivityAdd.events||!this.customActivityAdd.events.length}}setEventEdited(){let t=this.events.map((t=>Object.assign({},t)));this.eventsModified=null;t=t.filter((t=>new Date(t.ts)<=new Date(this.eventSelect.start)||new Date(t.ts)>=new Date(this.eventSelect.end)));this.eventSelectEdited=Object.assign({},this.eventSelect);switch(this.tab){case 1:if(this.activityEdit&&this.eventSelect.event.activity!==this.activityEdit){t=this.replaceActivity(t)}this.setStartAndEndDisplay(this.eventSelectEdited.start,this.eventSelectEdited.end,15);break;case 2:if(this.startEdit&&new Date(this.startEdit).valueOf()!==new Date(this.eventSelect.start).valueOf()){t=this.editStartActivity(t)}this.setStartAndEndDisplay(this.eventSelect.start,this.eventSelect.end,15);break;case 3:if(this.endEdit&&new Date(this.endEdit).valueOf()!==new Date(this.eventSelect.end).valueOf()){t=this.editEndActivity(t)}this.setStartAndEndDisplay(this.eventSelect.start,this.eventSelect.end,15);break;case 4:if(this.customActivityAdd.events&&this.customActivityAdd.events.length){t=this.addActivity(t)}if(this.customActivityAdd.start&&this.customActivityAdd.end){this.eventSelectEdited={start:new Date(this.customActivityAdd.start),end:new Date(this.customActivityAdd.end)};this.setStartAndEndDisplay(this.eventSelectEdited.start,this.eventSelectEdited.end,60)}break}return t}refresh(){switch(this.tab){case 1:this.activityEdit=null;break;case 2:this.startEdit=null;this.inputDateTimeStart.date=this.eventSelect.start;this.inputDateTimeStart.setError(false);break;case 3:this.endEdit=null;this.inputDateTimeEnd.date=this.eventSelect.end;this.inputDateTimeEnd.setError(false);break}this.setHaveError(false);this.eventsEdited=this.setEventEdited();this.timelineEditedElement.updatePeriodAndEvent(this.eventsEdited,[],this.lastEvent)}renderReplaceMode(){const t=this.getPossibleActivities(this.eventSelect.event.activity);return s("div",{class:"container-remplaceMode"},s("p",null,this.eventSelect.event?this.i18n.get(this.eventSelect.event.activity):"?"),s("s3p-icon-v2",{class:"icon-svg iconClick",name:"arrow-forward"}),s("select",{class:"select-custom",onInput:t=>this.setActivityEdit(t.target)},s("option",{value:""},this.i18n.get("chooseActivity")),t?t.map((t=>s("option",{value:t,selected:this.activityEdit===t},this.i18n.get(t)))):""),s("div",{class:"btn-refresh",onClick:()=>{this.refresh()}},s("s3p-icon-v2",{class:"icon-svg iconClick",name:"custom-refresh",center:true})))}renderStartEditMode(){return s("div",{class:"container-dateChange"},s("s3p-input-datetime",{idInput:"startActivity",dateMax:this.startActivity.max,dateMin:this.startActivity.min,date:this.startActivity.start,onDateTimeChange:t=>{this.setStartEdit(t)},ref:t=>this.inputDateTimeStart=t}),s("div",{class:"btn-refresh",onClick:()=>{this.refresh()}},s("s3p-icon-v2",{class:"icon-svg iconClick",name:"custom-refresh",center:true})))}renderEndEditMode(){return s("div",{class:"container-dateChange"},s("s3p-input-datetime",{idInput:"endActivity",dateMin:this.endActivity.min,dateMax:this.endActivity.max,date:this.endActivity.end,onDateTimeChange:t=>{this.setEndEdit(t)},ref:t=>this.inputDateTimeEnd=t}),s("div",{class:"btn-refresh",onClick:()=>{this.refresh()}},s("s3p-icon-v2",{class:"icon-svg iconClick",name:"custom-refresh",center:true})))}renderAddMode(){return s("s3p-add-custom-activity",{activitiesOutsideVehicle:this.activitiesOutsideVehicle,maxStartFutur:this.actionType==="edit"?null:this.maxStartFutur,activityEdit:this.activityAddEdit,pastLimit:this.setLimitToAddCustomActivity(),onSendEventsAdd:t=>{this.setCustomActivityAdd(t)}})}setTab(){let t=1;if(this.eventSelect.event.correction){if(this.eventSelect.event.correction.new&&this.eventSelect.event.correction.new.customActivityId){t=3}else{t=2}}let e=[{name:1,icon:"custom-repeat",displayName:this.i18n.get("replaceActivity"),display:true,disabled:t===3},{name:2,icon:"custom-clock-forward",displayName:this.i18n.get("editStart"),display:true,disabled:this.eventSelect.event.activity==="R"||t===3},{name:3,icon:"custom-clock-return",displayName:this.i18n.get("editEnd"),display:true,disabled:this.eventSelect.event.activity==="R"||t===3},{name:4,icon:"add",displayName:this.i18n.get("addActivity"),display:true,disabled:t===2}];return s("div",null,s("s3p-tabs-v2",{tabs:e,styleGraphic:2,onChangeTabEvent:t=>{this.changeTab(t.detail)}},s("div",{slot:"item-1"},this.renderReplaceMode()),s("div",{slot:"item-2"},this.renderStartEditMode()),s("div",{slot:"item-3"},this.renderEndEditMode()),s("div",{slot:"item-4"},this.renderAddMode())))}setHaveError(t){this.haveError[this.tab]=t;this.haveError=Object.assign({},this.haveError)}renderErrorMessage(){if(this.haveError[this.tab]){switch(this.tab){case 2:return this.i18n.get("errorMessageIntervalDate",l(this.startActivity.min,"00/00/0000 00:00"),l(this.startActivity.max,"00/00/0000 00:00"));case 3:return this.i18n.get("errorMessageIntervalDate",l(this.endActivity.min,"00/00/0000 00:00"),l(this.endActivity.max,"00/00/0000 00:00"));case 4:return`${this.i18n.get("errorMessageIntervalDate2")} ${l(this.maxStartFutur,"00/00/0000 00:00")} `}}}render(){return s("div",{class:"editorTimeline s3pChartComponent"},s("div",{class:"containerCorrection"},s("div",null,this.setTab()),s("div",{class:"container-form"},this.showWarningMessage?s("div",{class:"container-warning"},s("p",null,this.i18n.get("correctionToValidate"))):"",this.blockEdition?s("div",{class:"container-error"},s("p",null,this.i18n.get("correctionInvalid"))):"",s("div",{class:"container-error"},s("p",null,this.renderErrorMessage())),s("div",{class:"container-textarea"},s("p",null,this.i18n.get("comment")),s("textarea",{class:"textarea-custom",onInput:t=>{this.setComment(t)}},this.comment?this.comment:null)),s("div",{class:"contains-timeline contains-timeline-noEdited"},s("p",null,this.i18n.get("before")),this.events&&this.display_start&&this.display_end?s("s3p-timeline",{events:this.events,stack:false,lastEvent_end:this.lastEvent,display_start:this.display_start,display_end:this.display_end,onStartAndEndChange:t=>{this.onChangeStartAndEndHandler(t,0)},eventSelect:this.eventSelect,ref:t=>this.timelineElement=t}):""),s("div",{class:"contains-timeline contains-timeline-edited"},s("p",null,this.i18n.get("after")),this.eventsEdited&&this.display_start&&this.display_end?s("s3p-timeline",{events:this.eventsEdited,stack:false,lastEvent_end:this.lastEvent,display_start:this.display_start,display_end:this.display_end,onStartAndEndChange:t=>{this.onChangeStartAndEndHandler(t,1)},eventSelect:this.eventSelect,ref:t=>this.timelineEditedElement=t}):""))),s("div",{class:"btnCorrectionValid"},s("button",{class:"btnChart",onClick:()=>{this.sendCorrection()},disabled:this.isDisabledForm()},this.i18n.get(this.validateCorrectionsMessage))))}get el(){return n(this)}};k.style=y;export{k as s3p_editor_timeline};
//# sourceMappingURL=p-35874ae8.entry.js.map