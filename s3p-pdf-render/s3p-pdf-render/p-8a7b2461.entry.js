import{r as t,h as i,c as e,a as s}from"./p-d5a6e412.js";import{b as h}from"./p-6f5893c5.js";import{a as r,l as n,b as o}from"./p-08d6daf2.js";import{m as a}from"./p-87ef56bd.js";import{m as l,a as c,b as p}from"./p-3dcb4c27.js";import{u as f,t as u,n as d,s as m}from"./p-d78cdf42.js";import{l as g,t as w}from"./p-affb5605.js";import"./p-3e8ff66b.js";function x(t,i){return i<t?-1:i>t?1:i>=t?0:NaN}function b(t,i){var e=t.length,s=-1,h,r;if(i==null){while(++s<e){if((h=t[s])!=null&&h>=h){r=h;while(++s<e){if((h=t[s])!=null&&r>h){r=h}}}}}else{while(++s<e){if((h=i(t[s],s,t))!=null&&h>=h){r=h;while(++s<e){if((h=i(t[s],s,t))!=null&&r>h){r=h}}}}}return r}function v(t,i){this._context=t;this._t=i}v.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=this._y=NaN;this._point=0},lineEnd:function(){if(0<this._t&&this._t<1&&this._point===2)this._context.lineTo(this._x,this._y);if(this._line||this._line!==0&&this._point===1)this._context.closePath();if(this._line>=0)this._t=1-this._t,this._line=1-this._line},point:function(t,i){t=+t,i=+i;switch(this._point){case 0:this._point=1;this._line?this._context.lineTo(t,i):this._context.moveTo(t,i);break;case 1:this._point=2;default:{if(this._t<=0){this._context.lineTo(this._x,i);this._context.lineTo(t,i)}else{var e=this._x*(1-this._t)+t*this._t;this._context.lineTo(e,this._y);this._context.lineTo(e,i)}break}}this._x=t,this._y=i}};function k(t){return new v(t,1)}const y="header{display:flex;align-items:center;box-shadow:0 2px 5px 0 rgba(0, 0, 0, 0.26);padding:10px 10px 10px 10px}h1{margin:auto}";const $=class{constructor(i){t(this,i);this.name=undefined}render(){return i("header",null,i("img",{class:"logo",src:"https://app.mapandtruck.io/assets/mapandtruck/logo_maptrcuk.png",height:"70",alt:"s3pweb"}),i("h1",null,"Rapport de ",this.name))}};$.style=y;const D="s3p-temperature .s3pTemperatureDiv{width:100%}s3p-temperature .chartD3{width:100%;max-width:1000px;background-color:white;height:350px !important;max-height:350px}s3p-temperature .chartD3 text{font:14px sans-serif}s3p-temperature .chartD3 #tooltiptemp{position:absolute;width:150px;padding:10px;background-color:white;border-radius:5px;border:1px solid #000;pointer-events:none;display:none;font-family:sans-serif;font-size:12px;font-weight:bold}";const j=class{constructor(i){t(this,i);this.pointClicked=e(this,"pointClicked",7);this.stateChecked=e(this,"stateChecked",7);this.idChart="chart";this.events=[];this.time_parse=f("%Y-%m-%dT%H:%M:%S.%LZ");this.time_format=u("%d-%m-%Y - %H-%M");this.regexSondes=["tempSensor(0?[1-9]|[1-9][0-9])Value","dischargeAir(0?[1-9]|[1-9][0-9])Temp","returnAir(0?[1-9]|[1-9][0-9])Temp"];this.regexConsignePoints=["tempSetpoint(0?[1-9]|[1-9][0-9])"];this.margin={top:20,right:10,bottom:70,left:70};this.sondes=[];this.consignePoints=[];this.sondeName=[];this.log=h("components:temperature")}async componentDidLoad(){this.log(" componentDidLoad this.events ",this.events);this.log(" componentDidLoad this.eventsTimeline ",this.eventsTimeline);this.chart_width=1e3-this.margin.left-this.margin.right;this.chart_height=300-this.margin.top-this.margin.bottom;this.setEvents()}setEvents(){this.log("setEvents from temperature component",this.events);if(this.events){for(let t in this.events){if(this.events[t].events&&this.events[t].events.length){this.refresh();break}}}}refresh(){this.sondes=[];this.consignePoints=[];this.sondeName=[];r(`#${this.idChart}`).selectAll("*").remove();this.init()}init(){this.log("*** init ***");this.setStatesProp();this.setAllDataChart();this.data=[];let t=Object.keys(this.allDataChart.sondes);t.map((t=>this.data=[...this.data,...this.allDataChart.sondes[t]]));let i=Object.keys(this.allDataChart.consignePoints);i.map((t=>this.data=[...this.data,...this.allDataChart.consignePoints[t]]));this.log("this.data",this.data);let e=this.minMax(this.data);this.min_value=e[0];this.max_value=e[1];this.maxTimeTemp=a(this.data,(t=>t.date));this.initD3();for(let i of t){this.drawSensorLine(i,this.allDataChart.sondes[i])}for(let t of i){this.drawPointLine(t,this.allDataChart.consignePoints[t])}this.drawTimeline();this.sendStateChecked();this.userInput.selectAll("checkboxes").data([...this.sondes,...this.consignePoints]).enter().append("label").style("margin-bottom","5px").style("margin-right","2px").style("font","sans-serif").style("color",(t=>t.color?t.color:"black")).html((t=>t.name)).append("input").attr("type","checkbox").property("checked",(t=>t.isCheck)).on("change",(t=>{t.isCheck=!t.isCheck;this.drawChart(t)}));this.setTooltipMultiLine()}setStatesProp(){this.statesProp=[];if(this.statesGroups&&this.statesGroups.length){for(const t of this.statesGroups){if(t&&t.displayModule==="temperature"){this.statesProp=[...this.statesProp,...t.states]}}}this.log("this.statesProp",this.statesProp)}setAllDataChart(){this.allDataChart={sondes:{},consignePoints:{}};for(let t of Object.keys(this.events)){if(this.events[t].events&&this.events[t].events.length){for(let i of this.events[t].events){for(let e of Object.keys(i)){this.pushData(e,i,t)}}}}this.log("this.allDataChart",this.allDataChart)}pushData(t,i,e){let s;for(let i of this.regexSondes){if(new RegExp(i).test(t)){s="sondes";break}}if(!s){for(let i of this.regexConsignePoints){if(new RegExp(i).test(t)){s="consignePoints";break}}}if(s){if(!this.allDataChart[s][t]){this.allDataChart[s][t]=[]}this.allDataChart[s][t].push({date:this.time_parse(i.ts),num:i[t],key:t,provider:e,inputId:i.inputId})}}drawTimeline(){let t=[];if(this.eventsTimeline&&this.eventsTimeline[0]){let i;for(let e of Object.keys(this.eventsTimeline)){let s=this.eventsTimeline[e];if(s.activity&&s.ts&&new Date(s.ts)<=new Date(this.display_end)){if(s.activity==="U"){s.activity="R"}if(!i){i=s}else{if(s.activity!==i.activity){t.push({activity:i.activity,start:i.ts,end:s.ts});i=s}}}}if(this.lastEvent_end&&new Date(this.lastEvent_end)<=new Date(this.display_end)){t.push({activity:i.activity,start:i.ts,end:this.lastEvent_end})}}this.svg.append("g").attr("class","timeline").selectAll("rect").data(t).enter().append("rect").attr("class","bar").attr("x",(t=>this.x_scale(new Date(t.start)))).attr("y",(t=>{switch(t.activity){case"D":return this.chart_height+this.margin.bottom-45;case"W":return this.chart_height+this.margin.bottom-35;case"A":return this.chart_height+this.margin.bottom-25;case"R":return this.chart_height+this.margin.bottom-15}})).attr("width",(t=>this.x_scale(new Date(t.end))-this.x_scale(new Date(t.start)))).style("fill",(t=>{switch(t.activity){case"D":return"var(--primary-drive-color, #01599d)";case"W":return"var(--primary-work-color, #d0000d)";case"A":return"var(--primary-available-color, #e67d20)";case"R":return"var(--primary-rest-color, #2f7f33)"}})).style("opacity",.7).attr("height",(t=>{switch(t.activity){case"D":return 45;case"W":return 35;case"A":return 25;case"R":return 15}}))}sendStateChecked(){let t=this.sondes.filter((t=>t.isCheck));let i=this.consignePoints.filter((t=>t.isCheck));let e=[...t.map((t=>t.prop)),...i.map((t=>t.prop))];this.stateChecked.emit(e)}drawChart(t){this.sendStateChecked();const i=this.svg.selectAll(`#${t.id}`).data([t],(t=>t.name));if(!t.isCheck){i.exit().remove();const e=this.svg.selectAll(`.point-${t.id}`).data([t],(t=>t.name));e.exit().remove()}else{if(t.type==="sonde"){i.enter().append("path").attr("class",t.className).attr("id",t.id).attr("fill","none").attr("stroke",(t=>t.color)).attr("stroke-width","1.5px").datum((t=>t.data)).attr("d",g().x((t=>this.x_scale(t.date))).y((t=>this.y_scale(t.num))))}else if(t.type==="consignePoints"){i.enter().append("path").attr("class",t.className).attr("id",t.id).attr("fill","none").attr("stroke",(t=>t.color)).attr("stroke-width","1.5px").datum((t=>t.data)).attr("d",g().x((t=>this.x_scale(t.date))).y((t=>this.y_scale(t.num))).curve(k))}}}drawLine(t,i,e,s){const h=t.match(/\d+/);e=e.filter((i=>i&&i.prop&&i.prop!=t));let r=this.getColorAndName(s[0].inputId,t,h,s[0].provider);e.push({number:h,name:r.name,color:r.color,isCheck:true,className:"line",id:t,prop:t,type:i,line:g().x((t=>this.x_scale(t.date))).y((t=>this.y_scale(t.num))),data:s});let n=e.findIndex((i=>i&&i.prop&&i.prop==t));this.createLine(e[n]);return e}createLine(t){this.svg.append("path").attr("class",t.className).attr("id",t.id).datum(t.data).attr("fill","none").attr("stroke",t.color).attr("stroke-width","1.5px").attr("d",t.line)}drawSensorLine(t,i){this.sondes=this.drawLine(t,"sonde",this.sondes,i)}drawPointLine(t,i){this.consignePoints=this.drawLine(t,"consignePoints",this.consignePoints,i)}getColorAndName(t,i,e,s){let h,r;if(this.statesProp&&this.statesProp.length){let e=this.statesProp.find((e=>e.inputId===t&&i===e.state));if(e){h=e.color;r=e.name}}if(!r){if(new RegExp("tempSensor(0?[1-9]|[1-9][0-9])Value").test(i)){r=this.getSondeName(e,s)}else if(new RegExp("tempSetpoint(0?[1-9]|[1-9][0-9])").test(i)){r="setPoint "+e}else{r=i}}return{color:h?h:this.getRandomColor(),name:r}}setTooltipMultiLine(){let t=this;let i=d().key((t=>t.key)).entries(this.data);let e=[...this.sondes,...this.consignePoints];let s=this.svg.append("g").attr("class","mouse-over-effects");s.append("path").attr("class","mouse-line").style("stroke","#2c3e50").style("stroke-width","1px").style("height","20px").style("opacity","0");let h=s.selectAll(".mouse-per-line").data(i).enter().append("g").attr("class","mouse-per-line");h.append("circle").attr("r",4).style("stroke",(function(t){let i=e.find((i=>i.prop===t.key));return i.color})).style("fill","none").style("stroke-width","1px").style("opacity","0");s.append("svg:rect").attr("width",t.chart_width).attr("height",t.chart_height).attr("fill","none").attr("pointer-events","all").on("mouseout",(function(){r(`#${t.idChart}`).select(".mouse-line").style("opacity","0");r(`#${t.idChart}`).selectAll(".mouse-per-line circle").style("opacity","0");r(`#${t.idChart}`).selectAll(".mouse-per-line text").style("opacity","0");r(`#${t.idChart}`).selectAll("#tooltiptemp").style("display","none")})).on("mouseover",(function(){r(`#${t.idChart}`).select(".mouse-line").style("opacity","1");r(`#${t.idChart}`).selectAll(".mouse-per-line circle").style("opacity",(function(t){let i=e.find((i=>i.prop===t.key));if(i&&i.isCheck){return 1}else{return 0}}));r(`#${t.idChart}`).selectAll("#tooltiptemp").style("display","block")})).on("click",(function(){let e=l(this);let s={};i.map((i=>{let h=t.x_scale.invert(e[0]);let r=o((function(t){return t.date})).left;let n=r(i.values,h);if(i.values[n]){s[i.values[n].key]=i.values[n].num;s["date"]=i.values[n].date}}));t.pointClicked.emit(s)})).on("mousemove",(function(){let s=l(this);let h=t.x_scale.invert(s[0]);let n;if(h<t.maxTimeTemp){m(".mouse-per-line").attr("transform",(function(i,e){let h=t.x_scale.invert(s[0]);let a=o((function(t){return t.date})).left;let l=a(i.values,h);if(i.values[l]&&i.values[l].date){n=t.x_scale(i.values[l].date);r(`#${t.idChart}`).select(".mouse-line").attr("d",(function(){if(i.values[l]&&i.values[l].date){let e="M"+t.x_scale(i.values[l].date)+","+(7*t.chart_height+t.margin.bottom/8);e+=" "+t.x_scale(i.values[l].date)+","+0;return e}}));return"translate("+t.x_scale(i.values[l].date)+","+t.y_scale(i.values[l].num)+")"}}));let h=[];i.map((i=>{let e=t.x_scale.invert(s[0]);let r=o((function(t){if(t.date){return t.date}})).left;let n=r(i.values,e);if(i.values[n]&&i.values[n].date){h.push({key:i.values[n].key,num:i.values[n].num})}}));h.sort((function(t,i){return x(t.num,i.num)}));let a=h.map((t=>t.key));let l=i.slice().sort((function(t,i){return a.indexOf(t.key)-a.indexOf(i.key)}));if(n){let i=document.getElementById(`svg${t.idChart}`).clientWidth;let h=document.getElementById(`svg${t.idChart}`).clientHeight;let a=i*n/1e3+70;let c=h*((t.chart_height+t.margin.top)/3)/(t.chart_height+t.margin.top);if(a+150>i){a=a-200}let p=false;r(`#${t.idChart}`).selectAll("#tooltiptemp").html("").style("left",a+"px").style("top",c+"px").style("display","block").selectAll().data(l).enter().append("div").html((i=>{let h=t.x_scale.invert(s[0]);let r=o((function(t){return t.date})).left;let n=r(i.values,h);if(i.values[n]){let t=e.find((t=>t.prop===i.key));let s="";if(!p){p=true;s+=`${i.values[n].date.toLocaleString("fr-FR")}<br/>`}if(t&&t.isCheck){s+=`${t.name} : <span style="color:${t.color};">${i.values[n].num} °C</span>`}else{s+=""}return s}}))}}}))}initD3(){this.x_scale=w().domain([this.display_start,this.display_end]).range([0,this.chart_width-0]);this.y_scale=n().domain([b(this.data,(t=>Number(t.num))),a(this.data,(t=>Number(t.num)))]).range([this.chart_height,0]);r(`#${this.idChart}`).append("div").attr("id","tooltiptemp");this.svg=r(`#${this.idChart}`).append("svg").attr("preserveAspectRadio","xMidYMid").attr("id",`svg${this.idChart}`).attr("viewBox",`0 0 1000 300`).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")");this.x_axis=c(this.x_scale).ticks(4).tickFormat(this.time_format);this.y_axis=p(this.y_scale).ticks(8).tickFormat((t=>t+" °C"));this.svg.append("g").attr("transform","translate(0,"+this.chart_height+")").call(this.x_axis);this.svg.append("g").attr("transform","translate("+0+",0)").call(this.y_axis);this.userInput=r(`#${this.idChart}`).append("div").attr("class","userInput").style("display","flex").style("justify-content","center").style("flex-wrap","wrap").style("padding-left","20px")}getRandomColor(){let t=["#1abc9c","#2ecc71","#3498db","#9b59b6","#34495e","#f1c40f","#e67e22","#e74c3c","#95a5a6"];t=t.filter((t=>!this.statesProp.some((i=>i&&i.color&&i.color.toLowerCase()==t))&&!this.sondes.some((i=>i&&i.color&&i.color.toLowerCase()==t))&&!this.consignePoints.some((i=>i&&i.color&&i.color.toLowerCase()==t))));return t[Math.floor(Math.random()*t.length)]}getSondeName(t,i){if(this.sondeName&&this.sondeName[t]){return this.sondeName[t]}else{let e;if(this.events[i].events&&this.events[i].events.length){e=this.events[i].events.find((i=>i[`tempSensor${t}Name`]))}if(e){this.sondeName[t]=e[`tempSensor${t}Name`];return this.sondeName[t]}else{return"Sonde n°"+t}}}minMax(t){let i=t.reduce((function(t,i){let e=i.num;t[0]=!t[0]?e:Math.min(t[0],e);t[1]=!t[1]?e:Math.max(t[1],e);return t}),[]);return i}render(){return i("div",{class:"s3pTemperatureDiv"},i("div",{id:this.idChart,class:"chartD3"}),i("div",null))}get el(){return s(this)}static get watchers(){return{events:["setEvents"]}}};j.style=D;export{$ as report_header,j as s3p_temperature};
//# sourceMappingURL=p-8a7b2461.entry.js.map